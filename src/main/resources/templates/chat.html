<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <th:block th:include="~{fragments/template:: head}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        var stompClient = null;

        function connect() {
            var socket = new SockJS('/websocket');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                var currentUserId = document.getElementById("currentUserId").value;
                stompClient.subscribe('/topic/messages/' + currentUserId, function (message) {
                    showMessage(JSON.parse(message.body));
                });
            });
        }

        function sendMessage() {
            var currentUserId = document.getElementById("currentUserId").value;
            var recipientId = document.getElementById("recipientId").value;
            var messageContent = document.getElementById("message").value;
            var message = {
                senderId: currentUserId,
                recipientId: recipientId,
                content: messageContent,
                timestamp: new Date().toISOString()
            };
            stompClient.send("/app/chat", {}, JSON.stringify(message));
            showMessage(message);
            document.getElementById("message").value = "";
        }

        function showMessage(message) {
            var messageArea = document.getElementById("messageArea");
            var messageElement = document.createElement("li");

            var messageClass = message.senderId == document.getElementById("currentUserId").value ? "you" : "recipient";
            messageElement.className = "chat-message " + messageClass;

            var avatarElement = document.createElement("i");
            avatarElement.appendChild(document.createTextNode(message.senderId == document.getElementById("currentUserId").value ? 'You' : 'Recipient'));
            messageElement.appendChild(avatarElement);

            var textElement = document.createElement("p");
            textElement.appendChild(document.createTextNode(message.content));
            messageElement.appendChild(textElement);

            messageArea.appendChild(messageElement);
        }



        document.addEventListener("DOMContentLoaded", function () {
            connect();
            document.getElementById("sendButton").addEventListener("click", sendMessage);
        });
    </script>
</head>
<body>
	<div th:replace="~{fragments/template :: sidebar}"></div>
	<nav th:replace="~{fragments/template  :: nav}">Navbar</nav>
   	<div class="main-content">
	    <div id="chatBox">
	        <h1>Chat with <span th:text="${recipientUsername}"></span></h1>
	        <ul id="messageArea">
	            <li th:each="message : ${messages}" th:class="${message.senderId == currentUserId} ? 'chat-message you' : 'chat-message recipient'">
	                <p th:text="${message.content}"></p>
	            </li>
	        </ul>
	        <input type="text" id="message" placeholder="Type your message here..."/>
	        <button id="sendButton">Send</button>
	        <input type="hidden" id="currentUserId" th:value="${currentUserId}" />
	        <input type="hidden" id="recipientId" th:value="${recipientId}" />
	    </div>
	</div>
</body>
</html>
